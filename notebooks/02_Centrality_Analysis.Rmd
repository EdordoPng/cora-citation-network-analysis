---
title: "02_Centrality_Analysis"
author: "Edoardo Diana"
date: "2025-11-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Indice 

   1 : Caricare le librerie e dati da usare
   2 : Calcolo di tutte le metriche di centralità
      * 2.1 : Degree centrality
          - In-degree
          - Out-degree
      * 2.2 : Closness Centrality (inutile)
      * 2.3 : Betweenness Centrality
      * 2.4 : Eigenvector Centrality (inutile)
      * 2.5 : Page Rank Centrality
      * 2.6 : HITS
      * 2.7 : Katz Centrality
      
   3 : Power 


##  1 : Caricare le librerie e dati da usare

```{r setup, include=FALSE}

library(igraph)
library(dplyr)
library(tidygraph)
#library(ggraph)
library(ggplot2)

```

Caricamento dati dal notebook precedente

```{r}

dir_processed <- "../data/processed"

graph <- readRDS(file.path(dir_processed, "graph.rds"))
content_nodes <- readRDS(file.path(dir_processed, "content_nodes.rds"))
edge_table_named <- readRDS(file.path(dir_processed, "edges.rds"))

cat("Oggetti caricati correttamente\n")

```

## 2 : Calcolo di tutte le metriche di centralità

  * Degre Centrality :

    - In-degree Centrality
    - Out-degree Centrality

  * Closness Centrality
  * Betweenness Centrality
  * Eigenvector Centrality
  * Page Rank Centrality
  * Katz Centrality

```{r}

graph <- graph %>%
  activate(nodes) %>%
  mutate(
    indegree = centrality_degree(mode = "in"),
    outdegree = centrality_degree(mode = "out"),
    pagerank = centrality_pagerank(),
    closeness = centrality_closeness(),
    betweenness = centrality_betweenness()
  )
```

## 2.1 Degree centrality

Il degree (grado) è il numero di archi incidenti a un nodo.
Ho un grafo diretto, dunque ne avrò 2 tipi : 

  - In-degree: numero di archi entranti (citazioni ricevute da un paper)

  - Out-degree: numero di archi uscenti (citazioni fatte da un paper)


Prendo i top 500 nodi più centrali considerando solo in-degree

```{r}

top_ids <- graph %>%
  as_tibble() %>%
  top_n(500, indegree) %>%
  pull(name)

subgraph_top <- graph %>%
  activate(nodes) %>%
  filter(name %in% top_ids)


```

Visualizzazione della rete considerando In-degree

```{r fig.width=12, fig.height=9, fig.align='center', warning=FALSE}

set.seed(42)

ggraph(subgraph_top, layout = "fr") +
  geom_edge_link(alpha = 0.2, edge_colour = "gray60") +
  geom_node_point(aes(color = category, size = indegree), alpha = 0.85) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Sottorete dei 500 paper più centrali",
    subtitle = "Centralità = in-degree + out-degree",
    size = "In-Degree Centrality",
    color = "Category"
  ) +
  theme_void() +
  theme(legend.position = "right")


```

## 2.2 : Closeness centrality

La closeness indica quanto un nodo si trova “vicino” a tutti gli altri, cioè l’inverso della distanza media (numero di passi minimi) dagli altri nodi raggiungibili.

Un paper con closeness alta è raggiungibile facilmente dagli altri e potenzialmente è un “crocevia” di informazioni


Ho però che la mia rete è "non fortemente connessa”, infatti la struttura delle citazioni è molto asimmetrica e “sparsa”.

In questi casi la closeness perde di informatività.
 
Infatti è molto informativa solo per reti fortemente connesse, mentre in reti grandi e dirette ho che molte distanze sono infinite.


Elenco i top 500 paper per Closeness

```{r}


# Estrai i top 10 paper per closeness centrality
top_closeness <- graph %>%
  as_tibble() %>%
  arrange(desc(closeness)) %>%
  select(name, closeness, category) %>%
  head(500)

print(top_closeness)


# Estraggo i nodi con closeness più alta
top_ids_closeness <- graph %>%
  as_tibble() %>%
  top_n(500, closeness) %>%
  pull(name)

# Creo la sottorete sui nodi con closeness più alta
subgraph_closeness <- graph %>%
  activate(nodes) %>%
  filter(name %in% top_ids_closeness)

```



## 2.3 : Betweenness centrality

La betweenness misura quante volte un nodo appare nei cammini minimi tra altri nodi. Rileva i “ponti” critici della rete.

Elenco i top 10 paper per Betweenness

High betweenness = ruolo di ponte/intermediazione.


Prendo i Top 10 paper per Betweenness, mostro la tabella ed il grafo a barre.

```{r}
top_betw <- graph %>%
  as_tibble() %>%
  arrange(desc(betweenness)) %>%
  select(name, betweenness, category) %>%
  head(10)

print(top_betw)


ggplot(top_betw, aes(x = reorder(name, betweenness), y = betweenness, fill = category)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 10 paper per Betweenness",
    x = "Paper ID",
    y = "Betweenness"
  )
```

Distribuzione della Betweenness centrality e Distribuzione della Betweenness centrality per categoria

```{r}

# Distribuzione della Betweenness centrality

graph %>%
  as_tibble() %>%
  ggplot(aes(betweenness)) +
  geom_histogram(bins = 60, fill = "steelblue", color = "gray20", alpha = 0.75) +
  labs(
    title = "Distribuzione della Betweenness centrality",
    x = "Betweenness",
    y = "Numero di paper"
  )


#Distribuzione Betweenness per categoria

graph %>%
  as_tibble() %>%
  ggplot(aes(x = category, y = betweenness, fill = category)) +
  geom_boxplot(show.legend = FALSE, outlier.size=0.5) +
  labs(
    title = "Distribuzione Betweenness per categoria",
    x = "Categoria",
    y = "Betweenness"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## 2.4 Eigenvector Centrality

A practical problem with eigenvector centrality is that it works well only if the graph is (strongly) connected

Le Directed real networks, come quella che qui stiamo considerano, non hanno tali caratteristiche.

If a directed network is not strongly connected, then only vertices that are in strongly connected components of at least two nodes or in the out-component of such components can have non-zero eigenvector centrality

## 2.5 Page Rank

Un nodo è importante se è linked da altri nodi importanti e cita altri nodi in modo parsimonioso.

Prendo i top 10 paper per Page Rank

```{r}

top_pagerank <- graph %>%
  as_tibble() %>%
  arrange(desc(pagerank)) %>%
  select(name, pagerank, category) %>%
  head(10)

print(top_pagerank)

```

Stampo un grafico a barre che mostra le stesse informazioni.
Poi mostro la distribuzione Globale del PageRank.

```{r}

ggplot(top_pagerank, aes(x = reorder(name, pagerank), y = pagerank, fill = category)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 10 paper per PageRank",
    x = "Paper ID",
    y = "PageRank",
    fill = "Categoria ML"
  ) +
  scale_fill_brewer(palette = "Set2")

# Distribuzione Globale del PageRank
graph %>%
  as_tibble() %>%
  ggplot(aes(pagerank)) +
  geom_histogram(bins = 60, fill = "steelblue", color = "gray20", alpha = 0.75) +
  labs(
    title = "Distribuzione del PageRank",
    x = "PageRank",
    y = "Numero di paper"
  )

```
## 2.6 : HITS

Qui abbiamo 2 tipi di nodi centrali : 

  - Autorità : contengono informazioni importanti riguardo il topic di interesse

  - Hub : mi dice dov trovare le informazioni autorevoli
  
Un nodo èpuò anche essr entrambi o nessuno


La Kleinberg centrality thesis dice : 

Un nodo è un' Autorità se è linkato da Hubs, è un Hub se linka delle Autorità.


```{r}

# Calcola HITS (Hub e Authority scores)
hits_result <- authority_score(graph, scale = TRUE)
hub_result <- hub_score(graph, scale = TRUE)

# Aggiungi ai nodi del grafo
graph <- graph %>%
  mutate(
    authority = hits_result$vector,
    hub = hub_result$vector
  )


```

Top 10 Authority (paper autorevoli)

```{r}

top_authority <- graph %>%
  as_tibble() %>%
  arrange(desc(authority)) %>%
  select(name, authority, category) %>%
  head(10)

print(top_authority)

```

Top 10 Hub (paper che linkano autorità)

```{r}

top_hub <- graph %>%
  as_tibble() %>%
  arrange(desc(hub)) %>%
  select(name, hub, category) %>%
  head(10)

print(top_hub)


```

Vediamo come sono distribuiti i vari paper

```{r fig.width=12, fig.height=9, fig.align='center', warning=FALSE}

graph %>%
  as_tibble() %>%
  ggplot(aes(x = authority, y = hub, color = category)) +
  geom_point(alpha = 0.6, size = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Relazione tra Authority e Hub score (HITS)",
    x = "Authority score",
    y = "Hub score",
    color = "Categoria ML"
  ) +
  theme_minimal()


```

Da analisi precedenti sappiamo che ogni paper riceve al massimo 5 citazioni in totale. 

Ciò si traduce nel fatto che un paper per essere un hub, ha solo 5 link a disposizione al massimo e deve cercare di linkare più authorities possibili.   


Network dei top 100 paper per authority score.

```{r fig.width=12, fig.height=9, fig.align='center', warning=FALSE}

coords <- layout_with_fr(igraph_sub)

plot(
  igraph_sub,
  layout = coords,
  vertex.size = 8 + 20 * (V(igraph_sub)$authority - min(V(igraph_sub)$authority)) / max(V(igraph_sub)$authority),
  # Puoi anche usare vertex.color = gradi diversi di blu/orange secondo authority
  vertex.color = "skyblue",
  vertex.label = round(V(igraph_sub)$authority, 2),
  vertex.label.cex = 0.80,
  edge.arrow.size = 0.5,
  main = "Top 100 paper"
)

# Di queti stessi top 100 per Authority, vado a vedere la stessa rete in cui guardo il corrispondente hub score.
plot(
  igraph_sub,
  layout = coords,
  vertex.size = 5 + 20 * (V(igraph_sub)$hub - min(V(igraph_sub)$hub)) / max(V(igraph_sub)$hub),
  vertex.color = "skyblue",  # o gradazione come già spiegato se vuoi distinguere di più
  vertex.label = round(V(igraph_sub)$hub, 2),
  vertex.label.cex = 0.80,
  edge.arrow.size = 0.5,
  main = "Top 100 paper – Hub score (HITS)"
)


```



## 2.7 : Katz centrality

Versione ricorsiva del degree, dove “essere vicino a nodi importanti” aumenta la centralità.

Prendo i top 10 paper per Katz

```{r}

top_katz <- graph %>%
  as_tibble() %>%
  arrange(desc(katz)) %>%
  select(name, katz, category) %>%
  head(10)

print(top_katz)

```




```{r}


```


```{r}


```
